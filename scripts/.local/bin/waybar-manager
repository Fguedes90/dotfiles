#!/bin/bash
# Script para gerenciar waybar e evitar mÃºltiplas instÃ¢ncias

# FunÃ§Ã£o para matar todas as instÃ¢ncias da waybar
kill_waybar() {
    pkill -x waybar
    sleep 0.5
}

# FunÃ§Ã£o para contar instÃ¢ncias
count_waybar() {
    pgrep -x waybar | wc -l
}

# FunÃ§Ã£o para iniciar waybar com proteÃ§Ã£o
start_waybar_safe() {
    # Primeiro, garantir que nÃ£o hÃ¡ instÃ¢ncias rodando
    kill_waybar
    
    # Aguardar um momento para garantir que processos foram encerrados
    sleep 1
    
    # Iniciar waybar
    waybar &
    
    # Log
    echo "$(date): Waybar iniciada (PID: $!)" >> /tmp/waybar-manager.log
}

# FunÃ§Ã£o para verificar e corrigir mÃºltiplas instÃ¢ncias
fix_multiple_instances() {
    local count=$(count_waybar)
    
    if [ "$count" -gt 1 ]; then
        echo "âš ï¸  Detectadas $count instÃ¢ncias da waybar. Corrigindo..."
        kill_waybar
        start_waybar_safe
        echo "âœ… Corrigido! Apenas 1 instÃ¢ncia rodando agora."
    elif [ "$count" -eq 0 ]; then
        echo "âŒ Nenhuma waybar rodando. Iniciando..."
        start_waybar_safe
        echo "âœ… Waybar iniciada!"
    else
        echo "âœ… Waybar rodando normalmente (1 instÃ¢ncia)"
    fi
}

# FunÃ§Ã£o principal
case "${1:-check}" in
    "start")
        start_waybar_safe
        ;;
    "restart")
        echo "ğŸ”„ Reiniciando waybar..."
        kill_waybar
        start_waybar_safe
        ;;
    "stop")
        echo "ğŸ›‘ Parando waybar..."
        kill_waybar
        ;;
    "fix")
        fix_multiple_instances
        ;;
    "check")
        count=$(count_waybar)
        echo "ğŸ“Š Status da waybar:"
        echo "   InstÃ¢ncias rodando: $count"
        if [ "$count" -gt 0 ]; then
            echo "   PIDs:"
            pgrep -x waybar | while read pid; do
                echo "     - $pid"
            done
        fi
        ;;
    "monitor")
        # Monitorar continuamente
        echo "ğŸ‘ï¸  Monitorando waybar (Ctrl+C para parar)..."
        while true; do
            count=$(count_waybar)
            if [ "$count" -gt 1 ]; then
                echo "$(date): MÃºltiplas instÃ¢ncias detectadas! Corrigindo..."
                fix_multiple_instances
            fi
            sleep 5
        done
        ;;
    *)
        echo "Uso: $0 {start|restart|stop|fix|check|monitor}"
        echo ""
        echo "  start   - Inicia waybar (mata duplicadas primeiro)"
        echo "  restart - Reinicia waybar"
        echo "  stop    - Para todas as instÃ¢ncias"
        echo "  fix     - Corrige mÃºltiplas instÃ¢ncias"
        echo "  check   - Verifica status"
        echo "  monitor - Monitora e corrige automaticamente"
        exit 1
        ;;
esac
